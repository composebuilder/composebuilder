<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ComposeBuilder - 可视化生成 docker-compose.yml</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://unpkg.com/vue@3.4.31/dist/vue.global.prod.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js" defer></script>
    <script src="app.js" defer></script>
  </head>
  <body>
    <div id="app" class="app">
      <header class="hero">
        <div class="hero__content">
          <p class="hero__eyebrow">ComposeBuilder</p>
          <h1>用图形化方式快速拼装你的 docker-compose.yml</h1>
          <p class="hero__subtitle">
            输入镜像，配置容器，立刻生成合并后的 Compose 配置文件。
          </p>
          <div class="hero__meta">
            <span>镜像：composebuilder/composebuilder</span>
            <span>前端架构：Vue 3</span>
          </div>
        </div>
        <div class="hero__art">
          <div class="orb orb--one"></div>
          <div class="orb orb--two"></div>
          <div class="orb orb--three"></div>
        </div>
      </header>

      <div class="layout">
        <div class="layout__left">
      <section class="panel panel--grid">
        <div class="panel__intro">
          <h2>镜像输入</h2>
          <p>支持一行一个镜像名称，或用逗号分隔。添加后可逐个配置。</p>
        </div>
        <div class="field">
          <label for="images">镜像名称</label>
          <textarea
            id="images"
            v-model="imageInput"
            placeholder="例如：nginx:latest, redis:7 或 mysql:8"
          ></textarea>
        </div>
        <p class="hint">需要导入现有配置时，请在底部直接编辑 YAML 并点击导入。</p>
        <div class="actions">
          <button class="button button--primary" @click="addImages">
            添加镜像
          </button>
          <button class="button button--ghost" @click="clearAll" :disabled="!services.length">
            清空全部
          </button>
        </div>
      </section>

      <section class="panel panel--wide">
        <div class="panel__intro">
          <h2>服务配置</h2>
          <p>逐个完善容器名称、端口、挂载、环境变量与健康检查。</p>
        </div>

        <div v-if="!services.length" class="empty">
          还没有服务，先在上方添加镜像。
        </div>

        <div
          v-for="service in services"
          :key="service.id"
          class="service-card"
          :style="{ borderLeftColor: service.color }"
          @mouseenter="setActiveService(service.id, $event)"
          @mouseleave="clearActiveService(service.id)"
          @focusin="setActiveService(service.id, $event)"
        >
          <div class="service-card__header">
            <div>
              <div class="service-card__title">
                <span class="color-tag" :style="{ background: service.color }"></span>
                <h3>{{ service.image }}</h3>
              </div>
              <p>服务名称：{{ service.serviceName || '待生成' }}</p>
            </div>
            <button class="button button--danger" @click="removeService(service.id)">
              移除
            </button>
          </div>

          <div class="grid">
            <div class="field">
              <label>容器名称来源</label>
              <select v-model="service.containerNameMode" @change="applyContainerNameMode(service)">
                <option value="developer">镜像开发者</option>
                <option value="image">镜像名称</option>
                <option value="custom">自定义</option>
              </select>
            </div>
            <div class="field">
              <label>容器名称</label>
              <input
                v-model.trim="service.containerName"
                :disabled="service.containerNameMode !== 'custom'"
                @input="syncServiceName(service)"
              />
            </div>
            <div class="field">
              <label>服务名称（自动同步）</label>
              <input v-model="service.serviceName" disabled />
            </div>
            <div class="field">
              <label>重启策略</label>
              <select v-model="service.restart">
                <option value="no">不自动重启</option>
                <option value="always">always</option>
                <option value="on-failure">on-failure</option>
                <option value="unless-stopped">unless-stopped</option>
              </select>
            </div>
            <div class="field">
              <label>网络模式</label>
              <select v-model="service.networkMode">
                <option value="ports">端口映射</option>
                <option value="bridge">网桥 (bridge)</option>
                <option value="host">宿主机 (host)</option>
              </select>
            </div>
            <div class="field">
              <label>特权模式</label>
              <select v-model="service.privileged">
                <option :value="false">关闭</option>
                <option :value="true">开启</option>
              </select>
            </div>
            <div class="field">
              <label>用户 ID</label>
              <input type="number" min="0" v-model.number="service.userId" />
            </div>
            <div class="field">
              <label>组 ID</label>
              <input type="number" min="0" v-model.number="service.groupId" />
            </div>
          </div>

          <div class="subpanel" v-if="service.networkMode !== 'host'">
            <div class="subpanel__header">
              <h4>端口映射</h4>
              <div class="actions">
                <button
                  class="chip"
                  @click="addPresetPort(service, 80)"
                  :disabled="hasPort(service, 80)"
                >
                  +80
                </button>
                <button
                  class="chip"
                  @click="addPresetPort(service, 443)"
                  :disabled="hasPort(service, 443)"
                >
                  +443
                </button>
                <div class="chip-group">
                  <span class="chip-label">连续端口</span>
                  <button
                    v-if="nextSequentialPort(service)"
                    class="chip"
                    @click="addPresetPort(service, nextSequentialPort(service))"
                  >
                    +{{ nextSequentialPort(service) }}
                  </button>
                  <span v-else class="chip-label">已到 3100</span>
                </div>
              </div>
            </div>
            <div v-for="(port, idx) in service.ports" :key="port.id" class="grid grid--ports">
              <div class="field">
                <label>宿主机端口</label>
                <input type="number" min="1" max="65535" v-model.number="port.host" />
              </div>
              <div class="field">
                <label>容器端口</label>
                <input type="number" min="1" max="65535" v-model.number="port.container" />
              </div>
              <div class="field">
                <label>协议</label>
                <select v-model="port.protocol">
                  <option value="tcp">tcp</option>
                  <option value="udp">udp</option>
                </select>
              </div>
              <button class="button button--ghost" @click="removePort(service, idx)">删除</button>
            </div>
            <button class="button button--ghost" @click="addPort(service)">添加端口</button>
            <p class="hint">可选范围推荐：80、443、3000-3100，也支持自定义。</p>
            <p class="hint" v-if="service.networkMode === 'bridge' && !service.ports.length">
              使用网桥时，需要有容器对外提供服务，请确保开放端口。
            </p>
          </div>
          <p class="hint" v-if="service.networkMode === 'host'">
            使用宿主机网络时无需端口映射，容器将直接使用宿主机网络栈。
          </p>

          <div class="subpanel">
            <div class="subpanel__header">
              <h4>挂载卷 / 目录</h4>
            </div>
            <div v-for="(vol, idx) in service.volumes" :key="vol.id" class="grid grid--vols">
              <div class="field">
                <label>类型</label>
                <select v-model="vol.kind" @change="syncVolumeDefaults(service, vol)">
                  <option value="bind">目录挂载</option>
                  <option value="volume">命名卷</option>
                </select>
              </div>
              <div class="field">
                <label>{{ vol.kind === 'bind' ? '宿主机目录' : '卷名称' }}</label>
                <input v-model.trim="vol.source" />
              </div>
              <div class="field">
                <label>容器目录</label>
                <input v-model.trim="vol.target" />
              </div>
              <div class="field">
                <label>只读</label>
                <select v-model="vol.readOnly">
                  <option :value="false">否</option>
                  <option :value="true">是</option>
                </select>
              </div>
              <button class="button button--ghost" @click="removeVolume(service, idx)">删除</button>
            </div>
            <button class="button button--ghost" @click="addVolume(service)">添加挂载</button>
            <p class="hint">
              推荐目录：/srv/{{ service.containerName || '容器名称' }}/data
            </p>
            <p class="hint">不推荐使用挂载卷，优先考虑挂载目录。</p>
          </div>

          <div class="subpanel">
            <div class="subpanel__header">
              <h4>环境变量</h4>
            </div>
            <div v-for="(env, idx) in service.env" :key="env.id" class="grid grid--env">
              <div class="field">
                <label>键</label>
                <input v-model.trim="env.key" />
              </div>
              <div class="field">
                <label>值</label>
                <input v-model.trim="env.value" />
              </div>
              <button class="button button--ghost" @click="removeEnv(service, idx)">删除</button>
            </div>
            <button class="button button--ghost" @click="addEnv(service)">添加环境变量</button>
          </div>

          <div class="subpanel">
            <div class="subpanel__header">
              <h4>服务依赖</h4>
            </div>
            <div class="field">
              <label>depends_on（仅显示已配置健康检查的服务）</label>
              <div class="checkbox-list" v-if="availableDependsOn(service).length">
                <label
                  class="checkbox-item"
                  v-for="dep in availableDependsOn(service)"
                  :key="dep.id"
                >
                  <input
                    type="checkbox"
                    :checked="service.dependsOn.includes(dep.serviceName || dep.containerName)"
                    @change="toggleDependsOn(service, dep.serviceName || dep.containerName)"
                  />
                  <span>{{ dep.serviceName || dep.containerName }}</span>
                </label>
              </div>
              <p class="hint" v-else>暂无已配置健康检查的服务可选。</p>
            </div>
          </div>

          <div class="subpanel">
            <div class="subpanel__header">
              <h4>启动命令</h4>
            </div>
            <div class="field">
              <label>command</label>
              <input v-model.trim="service.command" placeholder="例如：nginx -g 'daemon off;'" />
            </div>
            <p class="hint">command 可为空，将不写入配置。</p>
          </div>

          <div class="subpanel">
            <div class="subpanel__header">
              <h4>健康检查</h4>
            </div>
            <div class="grid">
              <div class="field">
                <label>类型</label>
                <select v-model="service.health.type">
                  <option value="none">不启用</option>
                  <option value="http">HTTP</option>
                  <option value="tcp">TCP</option>
                  <option value="cmd">自定义命令</option>
                </select>
              </div>
              <div class="field" v-if="service.health.type !== 'none' && service.health.type !== 'cmd'">
                <label>端口</label>
                <input type="number" min="1" max="65535" v-model.number="service.health.port" />
              </div>
              <div class="field" v-if="service.health.type === 'cmd'">
                <label>命令</label>
                <input v-model.trim="service.health.cmd" placeholder="例如：curl -f http://localhost:8080" />
              </div>
              <div class="field">
                <label>间隔</label>
                <input v-model.trim="service.health.interval" placeholder="30s" />
              </div>
              <div class="field">
                <label>超时</label>
                <input v-model.trim="service.health.timeout" placeholder="5s" />
              </div>
              <div class="field">
                <label>重试次数</label>
                <input type="number" min="1" v-model.number="service.health.retries" />
              </div>
              <div class="field">
                <label>启动宽限期</label>
                <input v-model.trim="service.health.startPeriod" placeholder="10s" />
              </div>
            </div>
          </div>
        </div>
      </section>
        </div>

        <div class="layout__right">
          <section class="panel panel--wide yaml-panel">
            <div class="panel__intro">
              <h2>YAML 展示区</h2>
              <p>右侧可直接编辑，点击刷新后同步到左侧。</p>
            </div>
            <div class="compose-output">
              <div class="compose-editor">
                <div class="line-numbers" ref="lineNumbers" :style="lineNumberStyle">
                  <span v-for="line in lineNumbers" :key="line">{{ line }}</span>
                </div>
                <textarea
                  ref="yamlArea"
                  v-model="composeYamlText"
                  @input="markYamlDirty"
                  @scroll="syncLineScroll"
                ></textarea>
              </div>
            </div>
            <div class="actions">
              <button class="button button--primary" @click="importFromYamlText" :disabled="!composeYamlText">
                刷新
              </button>
              <button class="button button--ghost" @click="downloadYaml" :disabled="!composeYamlText">
                下载 YAML
              </button>
            </div>
          </section>

          <section class="panel panel--wide panel--compact editor-panel" v-if="activeService">
            <h3>正在编辑：{{ activeService.image }}</h3>
          </section>
        </div>
      </div>

      <footer class="footer">
        <p>ComposeBuilder - 让 compose 配置更直观。</p>
      </footer>
    </div>
  </body>
</html>
